# تکنولوژی های مورد استفاده در پروژه

پایگاه داده استفاده شده در پروژه : postgresql
صف : rabbitmq
فرم ورک استفاده شده : spring boot 2.3.3 می باشد و جهت اتصال به پایگاه داده از spring data jpa استفاده شده است
مستند سازی وب سرویسها: swagger

# نحوه اجرای سرویس ها
جهت اجرای برنامه ** اسکرپیت run.sh موجود در برنامه **  را اجرا نمایید 
جهت ساده سازی اجرای سرویس ها از docker استفاده شده است. همانطور که در فایل run.sh ملاحظه می نمایید پس از build کردن برنامه با استفاده از docker build سایر سرویس ها با استفاده ازدستور زیر بالا آمده اند.
docker-compose up -d --remove-orphans
با اجرای این دستور  سرویس ها به ترتیب زیر بالا آورده می شوند. 
سرویس rabbitmq بر روی پورت 15672 بالا می آید. شما قادر هستید با مراجعه به آدرس http://localhost:15672  و با نام کاربری guest و پسورد guest به rabbitmq  وارد شوید.
سرویس postgres
برنامه cardmanagement
برنامه NotificayionService

# معرفی برنامه CardMAnagementSystem

هدف نوشتن سرویس مدیریت و انتقال کارت با قابلیت های زیر مبی باشد.
سرویس اضافه کردن کارت
سرویس حذف کارت
سرویس مشاهده لیست کارت ها
سرویس انتقال وجه
سرویس گزارش انتقال
در ادامه هر یک از سرویس ها به تفکیک توضیح داده می شوند.

## سرویس اضافه کردن کارت
جهت فراخوانی این سرویس دو سرویس با استفاده از spring rest و با متد post نوشته شده است.
نام سرویس انجام دهنده این کار UserController می باشد و آدرس فراخوانی به صورت زیر می باشد:
http://localhost:8001/users
http://localhost:8001/users/cards
با توجه به مفروضات مساله گفته شده است که کاربر از پیش در سیستم تعریف شده است. در این صورت برای کار با کارت باید با یک یا نهایتا چند کاربر اضافه کردن کارت صورت می گرفت و این کاربران یا در properties تعریف شوند یا به صورت hard code تعریف شوند. لیکن در این برنامه جهت واقعی تر نمودن فرایند ثبت کارت برای کاربر دو سرویس اضافه شد.
**سرویس اضافه کردن کاربر**
در سرویس اول می توان مشخصات کاربر از جمله شماره تلفن و نام کاربر را به همراه لیستی از کارت ها در سیستم ثبت نمود. البته فرض شده است که بنا به هر دلیلی هم بتوان فقط کاربر را در سیستم ثبت نمود و سپس کارت را به کاربر اختصاص داد. بنابر این در این معرفی لیست کارت ها اجباری در نظر گرفته نشده است. از آنجاییکه در سرویس های بعدی نیاز به استفاده از شماره تلفن کاربر جهت ارسال اس ام اس وجود دارد ورود شماره تلفن کاربر و یکتا بودن این فیلد اجباری است.
**سرویس اضافه کردن کارت به لیست کارت های کاربر موجود**
در سرویس دوم میتوان به لیست کارت های کاربر موجود کارت اضافه نمود. شماره کارت کاربر یکتا است و نمی توان شماره کارت تکراری ذخیره نمود و در صورت ورود شماره کارت تکراری با خطا مواجه خواهید شد.

## سرویس حذف کارت
 آدرس فراخوانی سرویس به صورت زیر می باشد:
http://localhost:8001/cards/{id}
در این سرویس کاربر با مشخص کردن id کارتی که میخواهد آن را حذف نماید کارت را حذف می نماید.
## سرویس مشاهده لیست کارت ها
آدرس فراخوانی سرویس با استفاده از متد get و به صورت زیر می باشد:
http://localhost:8001/cards/{userId}
با توجه به اینکه در این سرویس هر کاربر فقط مجاز است که کارت های خود را حذف نماید و از آنجاییکه در پروژه security در نظر گرفته نشده است که بتوان نام کاربر را دریافت نمود باید  شماره کاربر را در path variable وارد نمود تا بر اساس آن مشخصات کارت های کاربر نمایش داده شود. 
از آنجاییکه تعدا کارت های یک کاربر معمولا محدود است نیازی به استفاده از pagination  در این سرویس دیده نشد.
## سرویس انتقال وجه
آدرس فراخوانی سرویس با استفاده از متد post و به صورت زیر می باشد:
http://localhost:8001/payments/transfer
در این سرویس فرد با انتخاب کارت خود می تواند عملیات انتقال کارت به کارت را انجام دهد و در صورت اعمال موفقیت به شماره مبدا پیامک ارسال می گردد.
در این سرویس سعی شده است مطابق دنیای واقعی یکسری validation بروی فیلدها در نظر گرفته شود از جمله اینکه شماره کارت باید بین ۱۶ تا ۱۹ رقم باشد. البته در دنیای واقعی رمز کارت و cvv2 به صورت plain رد و بدل نمی شوند ولی با توجه به عدم نیاز مساله به encryption عملیات رمزنگاری بر روی رمز و cvv2 انجام نشده است.
###عملیات انتقال وجه
بنابر نیاز مساله دو payment provider در نظر گرفته شده است که در صورتی که ۴ رقم ابتدای کارت با 6037 آغاز شود باید paymentProvider1 و در غیر اینصورت از payment provider2جهت انجام عملیات استفاده شود.
جهت پیاده سازی این نیاز از پترن استراتژی استفاده شده است تا در زمان اجرا مشخص شود که کدام provider می بایست کار انتقال را انجام دهد. البته در این قسمت با توجه به اینکه تنها دو provider داریم نیازی به استفاده از پترن نبود لیکن این کار قابلیت توسعه برنامه را افزایش می دهد.
با توجه به اینکه عملیات انتقال بانکی توسط provider های مختلف انجام می شود می توان این سرویس را نیز به عنوان یک میکر سرویس دیگر و ارتباط با برنامه کنونی را از طریق صف و همانند سرویس notification که در ادامه می آید در نظر گرفت.جهت بهبود کارایی عمل انتقال و multi thread بودن برنامه نوع بازگشتی متد Async می باشد تا تردها منتظر آمدن جواب نشوند و نهایتا منجر به کندی سیستم نگردد.
همچنین برای provider ها timeout در نظر گرفته شده است تا در صورتیکه طبق زمان مشخصی پاسخ ارسال نگردد جواب عملیات ناموفق به کاربر ارسال گردد.
در صورتیکه به هر دلیل سرویس همه تراکنش ها در زمان بالا ولی کمتر از timeout  جواب دهد از آنجاییکه ممکن است به عملکرد کلی سیستم ضربه وارد شود  جهت جلوگیری از این مورد از circuit breaker استفاده شده است.
###ذخیره سازی تراکنش در پایگاه داده
در هر صورت چه ارسال موفق باشد و چه موفق نباشد اطلاعات تراکنش از جمله شماره کارت مبدا  شماره کارت مقصد و تاریخ انقضای کارت به همراه اطلاعات اضافی زیر در پایگاه داده ذخیره می شوند.
successStatus, failStatus, transactionDate
بنا به دلایل امنیتی نیازی به ذخیره سازی pin و cvv2 در جدول تراکنش نمی باشد. 
 علت در نظر گرفتن دو فیلد موفق و ناموفق برای status مربوط به تراکنش ها این است که در هنگام گزارش گیری نیازی نباشد دو مرتبه به سراغ پایگاه داده برویم چرا که مطابق مفروضات مساله دیتابیس تراکنش ها دارای حجم بالای داده است و query گرفتن از آن زمانبر می باشد.
از آنجایی که عملیات ذخیره سازی در پایگاه داده نباید به صورت sync شده و نهایتا منجر به کند شدن سایر عملیات شود جهت بهینه سازی کل عملیات کار ذخیره سازی در پایگاه داده از طریق صف به سرویس دیگری ارسال می شود. جهت انجام اینکار از  rabbitmq استفاده شده است.
###ارسال پیامک
در صورت موفق بودن تراکنش باید برای شماره مبدا کارت اس ام اس ارسال گردد. سرویس ارسال اس ام اس تحت عنوان یک سرویس جداگانه و تحت عنوان Notification Service در نظر گرفته شده است. 
ارتباط میان سرویس Card Management و Notification Service از طریق صف rabbitmq انجام می گردد.  
### مدیریت خطای شبکه در ارسال پیامک
در صورتی که به هر دلیلی سرویس ارسال اس ام اس با exception ای برخورد کند صف به صورت مکرر این سرویس را فراخوانی می نماید. جهت جلوگیری ازاین مشکل از dead letter queue استفاده گردیده است.
ماکزیمم تعداد دفعات فراخوانی سرویس و فاصله زمانی تکرار فراخوانی ها و سایر ویژگی ها در فایل properties آورده شده است. 
طبق نیاز مساله باید اطمینان حاصل شود که پیامک ارسال موفق به دست provider رسیده است از acknowledge به صورت manual در rabbitmq استفاده شده است. در این صورت consumer در صورت موفقیت ack را به دست provider رسانده و همچنین provider نیز با استفاده از config های موجود در فایل amqp.config اطمینان حاصل می نماید که پیام بر روی exchange قرار گرفته است.

## سرویس گزارش انتقال
آدرس فراخوانی سرویس با استفاده از متد post و به صورت زیر می باشد:
http://localhost:8001/transactions?page=   &total =
مقادیر page و total را به عنوان path parameter  در ورودی آدرس ارسال نمایید.
در این سرویس گزارش تراکنش های انجام شده در یک بازه زمانی در اختیار کاربر قرار می گید. همانطور که در سرویس انتقال کارت به کارت گفته شد همه تراکنش ها در پایگاه داده ذخیره می شوند. 
از آنجاییکه پایگاه داده تراکنش ها حجم بالایی از داده را دارد و باید در بازه زمانی مشخص گزارش گیری انجام شود بر روی فیلدهای cardNumber و transactionDate اندیس گذاشته شده است. فرض شده است مجموع این دو فیلد در پایگاه داده تراکنش یکتاست. 
در دنیای واقعی فیلدهای دیگری از جمله شماره رهگیری (RRN) نیز در نظر گرفته می شود.
از آنجایی که در گزارش گیری لازم نیست لیست همه تراکنش ها در یک صفحه نمایش داده شود گزارش گیری از پایگاه داده به صورت paginated می باشد این کار منجر به بهبود زمان گزارش گیری می گردد.
# اجرای تست های برنامه
برای سرویس های card و transaction تست unit و integration نوشته شده است و بابالا آمدن برنامه تست ها اجرا می گردند.
# نحوه تست برنامه
جهت تست functionality برنامه می توان از postman استفاده نمود. در این برنامه جهت  api documentation از swagger استفاده شده است. جهت مشاهده ورودی وب سرویس ها می توانید از آدرس زیر استفاده نمایید.
http://localhost:8001/swagger-ui/index.html

